# vim: ft=gitconfig:

# Identity
[user]
    name = {{ .name }}
    email = {{ .email }}

{{ if .is_private -}}
[credential]
    helper = pass --prefix tokens
    useHttpPath = true
{{ end -}}

# Reasonable defaults
[init]
    defaultBranch = main
[core]
    pager = less
[submodule]
    recurse = true
[push]
    default = simple
[pull]
    ff = only
[commit]
    verbose = true
[color]
    ui = true
[filter "lfs"]
    clean = git-lfs clean -- %f
    smudge = git-lfs smudge -- %f
    process = git-lfs filter-process
    required = true

# Editor
[core]
    editor = nvim
    autocrlf = input
    pager = delta
	fsmonitor = true
[interactive]
    diffFilter = delta --color-only
[delta]
    navigate = true
[diff]
    colorMoved = default
    external = difft
[difftool]
    prompt = false
[difftool "nvimdiff"]
    cmd = "nvim -d \"$LOCAL\" \"$REMOTE\""
[merge]
    conflictstyle = diff3
    tool = nvimdiff
[merge "mergiraf"]
    name = mergiraf
    driver = mergiraf merge --git %O %A %B -s %S -x %X -y %Y -p %P -l %L
[mergetool]
    prompt = false
    keepBackup = false
[mergetool "vimdiff"]
    path = nvim

# Aliases
#
# See the following website article for a good introduction:
#   http://haacked.com/archive/2014/07/28/github-flow-aliases/
#
[alias]
    # Edit this file
    ec = !nvim ~/.local/share/chezmoi/dot_config/git/config.tmpl

# Inspection
    # Show short status.
    st = status -s

    # Show latest commit.
    last = log -1 HEAD
    lastdiff = diff HEAD~

    # Show a compact log.
    ls = log --pretty=format:"%C(yellow)%h%Cred%d\\ %Creset%s%Cblue\\ [%an]" --decorate
    lsm = ls main..

    # Show the commit graph.
    graph = log --decorate=short --simplify-merges --oneline --graph
    glog = log --color --graph --pretty=format:'%Cred%h%Creset%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit

    # Use difftastic
    dl = -c diff.external=difft log -p --ext-diff
    ds = -c diff.external=difft show --ext-diff
    dft = -c diff.external=difft diff

    # Open status within Vim using the fugitive plugin.
    # - Make the status window the only one.
    # - Add a buffer mapping that will stage a hunk and move the screen so the cursor is on top.
    vstatus = !nvim -c Git -c 'silent only' -c 'autocmd FileType fugitive nmap <buffer> S szt'
    vs = !git vstatus

    # Open log within Vim using the fugitive plugin.
    vlog = !nvim -c 'Git log' -c 'only'
    vl = !git vlog

    # Search the repository for the text
    vack = "!f() { nvim -c \"Ack '$@'\"; }; f"
    vv = !nvim -c GV
    vf = !nvim -c "GV!"

    # Launch a GUI without messing up the terminal.
    gui = !gitg </dev/null >/dev/null 2>&1 &

    # List all text files in repository
    ls-text-files = grep --cached -Il ''

# Checking out
    co = checkout
    cob = checkout -b
    swc = switch -c
    prev = checkout HEAD~1
    sync = !git submodule sync --recursive && git submodule update --init --recursive

# Cleaning working directory
    shred = "!f() { git checkout -- ${1-.} && git clean -f ${1-.}; }; f"
    sweep = "!f() { git clean -n "$*"; printf 'Clean? [Y/n] '; read answer; if echo ${answer} | grep -Eq '^[nN][oO]?$'; then return; fi; git clean -f $*; }; f"

# Branch management
    up = pull -p
    usurp = push --force
    surrender = "!git reset --hard $(git rev-parse --abbrev-ref HEAD@{upstream})"
    pushthis = "!git push -u origin $(git rev-parse --abbrev-ref HEAD)"

    mine = "!f() { git branch -r | grep -v -- '->' | xargs -L1 git --no-pager show -s --oneline --author='{{ .email }}'; }; f"
    bclean = "!f() { git branch --merged ${1-main} | grep -v \" ${1-main}$\" | xargs -r git branch -d; }; f"
    bdone = "!f() { git checkout ${1-main} && git pull -p && git bclean ${1-main}; }; f"

# Commiting
    cc = commit
    cf = commit --fixup
    ca = commit --amend
    stash-as = "!f() { git add -A && git commit -n -m \"${2-stash}\" && git branch -c \"stash/${1?need stash name}\" && git reset HEAD~1 --hard; }; f"
    reset-last = reset HEAD~1

# Rebasing
    rb = rebase
    rbc = rebase --continue
    rba = rebase --abort
    rbs = "!f() { git rebase -i --autosquash \"${1-main}\" \"${@:2}\"; }; f"

# Cherry-picking
    cp = cherry-pick
    cpc = cherry-pick --continue
    cpa = cherry-pick --abort

# Code review
    shame = blame -w -M

    # List files which have changed since $1.
    files = "!f() { git diff --name-only $(git merge-base HEAD \"${1-main}\") \"${@:2}\"; }; f"

    # List files which have changed since $1 and show diff stat for each.
    stat = "!f() { git diff --stat $(git merge-base HEAD \"${1-main}\") \"${@:2}\"; }; f"

    # Open all files changed since $1 in Vim tabs and run fugitive's
    # :Gdiff in each tab.
    review = "!f() { nvim -p $(git files) -c \"tabdo Gdiff ${1-main}\"; }; f"

    # Same as the above, except specify names of files as arguments,
    # instead of opening all files.
    reviewone = "!f() { nvim -p -c \"tabdo Gdiff ${1-main}\"; }; f"

# Online
    serve = daemon --verbose --export-all --base-path=.git --reuseaddr --strict-paths .git/
    package = "!f() { git archive --format=tar --prefix=\"$1/\" \"$2\" | gzip > \"$1.tar.gz\"; }; f"
